
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>dps310.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @addtogroup DPS310</a>
<a name="ln3"> *</a>
<a name="ln4"> */</a>
<a name="ln5">/** @{ */</a>
<a name="ln6">/** @file dps310.c</a>
<a name="ln7"> *</a>
<a name="ln8"> * @brief Implementation of DPS310 driver</a>
<a name="ln9"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln10"> * @date 2020-12-07</a>
<a name="ln11"> * @copyright Ruuvi Innovations, License MIT.</a>
<a name="ln12"> *</a>
<a name="ln13"> */</a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;dps310.h&quot;</a>
<a name="ln16">#include &quot;dps310_reg.h&quot;</a>
<a name="ln17">#include &lt;stddef.h&gt;</a>
<a name="ln18"> </a>
<a name="ln19">// Valid up to 31 bits</a>
<a name="ln20">static int32_t twos_complement (const uint32_t value, const uint8_t bits)</a>
<a name="ln21">{</a>
<a name="ln22">    const int32_t max_signed_value_exclusive = (int32_t) (1U &lt;&lt; (bits - 1U));</a>
<a name="ln23">    int32_t complement = (int32_t) value;</a>
<a name="ln24"> </a>
<a name="ln25">    if (complement &gt;= max_signed_value_exclusive)</a>
<a name="ln26">    {</a>
<a name="ln27">        complement -= 2 * max_signed_value_exclusive;</a>
<a name="ln28">    }</a>
<a name="ln29"> </a>
<a name="ln30">    return complement;</a>
<a name="ln31">}</a>
<a name="ln32"> </a>
<a name="ln33">static dps310_status_t ctx_status_check (const dps310_ctx_t * const ctx)</a>
<a name="ln34">{</a>
<a name="ln35">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln36"> </a>
<a name="ln37">    if ( (NULL == ctx)</a>
<a name="ln38">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln39">            || (NULL == ctx-&gt;write)</a>
<a name="ln40">            || (NULL == ctx-&gt;read))</a>
<a name="ln41">    {</a>
<a name="ln42">        status = DPS310_ERROR_NULL;</a>
<a name="ln43">    }</a>
<a name="ln44">    else if (ctx-&gt;device_status &gt; DPS310_MAX_OK)</a>
<a name="ln45">    {</a>
<a name="ln46">        status = ctx-&gt;device_status;</a>
<a name="ln47">    }</a>
<a name="ln48">    else if (DPS310_NOT_INITIALIZED == ctx-&gt;device_status)</a>
<a name="ln49">    {</a>
<a name="ln50">        status = DPS310_INVALID_STATE;</a>
<a name="ln51">    }</a>
<a name="ln52">    else</a>
<a name="ln53">    {</a>
<a name="ln54">        // No action needed.</a>
<a name="ln55">    }</a>
<a name="ln56"> </a>
<a name="ln57">    return status;</a>
<a name="ln58">}</a>
<a name="ln59"> </a>
<a name="ln60">static dps310_status_t ctx_ready_check (const dps310_ctx_t * const ctx)</a>
<a name="ln61">{</a>
<a name="ln62">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln63"> </a>
<a name="ln64">    if ( (NULL == ctx)</a>
<a name="ln65">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln66">            || (NULL == ctx-&gt;write)</a>
<a name="ln67">            || (NULL == ctx-&gt;read))</a>
<a name="ln68">    {</a>
<a name="ln69">        status = DPS310_ERROR_NULL;</a>
<a name="ln70">    }</a>
<a name="ln71">    // Bus error code must be returned as-is to application.</a>
<a name="ln72">    else if (DPS310_BUS_ERROR == ctx-&gt;device_status)</a>
<a name="ln73">    {</a>
<a name="ln74">        status = DPS310_BUS_ERROR;</a>
<a name="ln75">    }</a>
<a name="ln76">    // Other states can be interpreted as invalid state.</a>
<a name="ln77">    else if (DPS310_READY != ctx-&gt;device_status)</a>
<a name="ln78">    {</a>
<a name="ln79">        status = DPS310_INVALID_STATE;</a>
<a name="ln80">    }</a>
<a name="ln81">    else</a>
<a name="ln82">    {</a>
<a name="ln83">        // No action needed.</a>
<a name="ln84">    }</a>
<a name="ln85"> </a>
<a name="ln86">    return status;</a>
<a name="ln87">}</a>
<a name="ln88"> </a>
<a name="ln89">static dps310_status_t read_coefs (dps310_ctx_t * const ctx)</a>
<a name="ln90">{</a>
<a name="ln91">    uint8_t coefs[DPS310_COEF_REG_LEN] = {0};</a>
<a name="ln92">    dps310_status_t reg_read_ret = ctx-&gt;read (ctx-&gt;comm_ctx, DPS310_COEF_START_REG,</a>
<a name="ln93">                                   coefs, DPS310_COEF_REG_LEN);</a>
<a name="ln94">    uint32_t reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C0_OFFSET] * 256U)</a>
<a name="ln95">                         + ( (uint32_t) coefs[DPS310_COEF_C0_OFFSET + 1U]))</a>
<a name="ln96">                       &gt;&gt; DPS310_COEF_C0_SHIFT;</a>
<a name="ln97">    ctx-&gt;c0 = twos_complement (reg_val, DPS310_COEF_C0_LEN_BITS);</a>
<a name="ln98">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C1_OFFSET] * 256U)</a>
<a name="ln99">                + ( (uint32_t) coefs[DPS310_COEF_C1_OFFSET + 1U]))</a>
<a name="ln100">              &amp; ( (1U &lt;&lt; DPS310_COEF_C1_LEN_BITS) - 1U);</a>
<a name="ln101">    ctx-&gt;c1 = twos_complement (reg_val, DPS310_COEF_C1_LEN_BITS);</a>
<a name="ln102">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET] * 256U * 256U)</a>
<a name="ln103">                + ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET + 1U] * 256U)</a>
<a name="ln104">                + ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET + 2U]))</a>
<a name="ln105">              &gt;&gt; DPS310_COEF_C00_SHIFT;</a>
<a name="ln106">    ctx-&gt;c00 = twos_complement (reg_val, DPS310_COEF_C00_LEN_BITS);</a>
<a name="ln107">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET] * 256U * 256U)</a>
<a name="ln108">                + ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET + 1U] * 256U)</a>
<a name="ln109">                + ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET + 2U]))</a>
<a name="ln110">              &amp; ( (1U &lt;&lt; DPS310_COEF_C10_LEN_BITS) - 1U);</a>
<a name="ln111">    ctx-&gt;c10 = twos_complement (reg_val, DPS310_COEF_C10_LEN_BITS);</a>
<a name="ln112">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C01_OFFSET] * 256U)</a>
<a name="ln113">                + ( (uint32_t) coefs[DPS310_COEF_C01_OFFSET + 1U]));</a>
<a name="ln114">    ctx-&gt;c01 = twos_complement (reg_val, DPS310_COEF_C01_LEN_BITS);</a>
<a name="ln115">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C11_OFFSET] * 256U)</a>
<a name="ln116">                + ( (uint32_t) coefs[DPS310_COEF_C11_OFFSET + 1U]));</a>
<a name="ln117">    ctx-&gt;c11 = twos_complement (reg_val, DPS310_COEF_C01_LEN_BITS);</a>
<a name="ln118">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C20_OFFSET] * 256U)</a>
<a name="ln119">                + ( (uint32_t) coefs[DPS310_COEF_C20_OFFSET + 1U]));</a>
<a name="ln120">    ctx-&gt;c20 = twos_complement (reg_val, DPS310_COEF_C20_LEN_BITS);</a>
<a name="ln121">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C21_OFFSET] * 256U)</a>
<a name="ln122">                + ( (uint32_t) coefs[DPS310_COEF_C21_OFFSET + 1U]));</a>
<a name="ln123">    ctx-&gt;c21 = twos_complement (reg_val, DPS310_COEF_C21_LEN_BITS);</a>
<a name="ln124">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C30_OFFSET] * 256U)</a>
<a name="ln125">                + ( (uint32_t) coefs[DPS310_COEF_C30_OFFSET + 1U]));</a>
<a name="ln126">    ctx-&gt;c30 = twos_complement (reg_val, DPS310_COEF_C30_LEN_BITS);</a>
<a name="ln127">    return reg_read_ret;</a>
<a name="ln128">}</a>
<a name="ln129"> </a>
<a name="ln130">static dps310_status_t soft_reset (dps310_ctx_t * const ctx)</a>
<a name="ln131">{</a>
<a name="ln132">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln133">    uint8_t cmd = DPS310_SOFT_RST_VAL;</a>
<a name="ln134">    status |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_RST_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln135"> </a>
<a name="ln136">    if (DPS310_SUCCESS == status)</a>
<a name="ln137">    {</a>
<a name="ln138">        ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln139">    }</a>
<a name="ln140">    else</a>
<a name="ln141">    {</a>
<a name="ln142">        status |= DPS310_BUS_ERROR;</a>
<a name="ln143">        ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln144">    }</a>
<a name="ln145"> </a>
<a name="ln146">    return status;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">static dps310_status_t read_revision (dps310_ctx_t * const ctx)</a>
<a name="ln150">{</a>
<a name="ln151">    dps310_status_t status = ctx_ready_check (ctx);</a>
<a name="ln152">    uint8_t revision[1U] = {0xFFU};</a>
<a name="ln153"> </a>
<a name="ln154">    if (DPS310_SUCCESS == status)</a>
<a name="ln155">    {</a>
<a name="ln156">        status |= ctx-&gt;read (ctx-&gt;comm_ctx, DPS310_PROD_ID_REG, revision, 1U);</a>
<a name="ln157"> </a>
<a name="ln158">        if (DPS310_SUCCESS == status)</a>
<a name="ln159">        {</a>
<a name="ln160">            ctx-&gt;product_id = revision[0U]  &amp; DPS310_PROD_ID_MASK;</a>
<a name="ln161">            ctx-&gt;revision_id = (revision[0U] &amp; DPS310_PROD_ID_REV_MASK)</a>
<a name="ln162">                               &gt;&gt; DPS310_PROD_ID_REV_SHIFT;</a>
<a name="ln163"> </a>
<a name="ln164">            if ( (DPS310_PRODUCT_ID_VAL != ctx-&gt;product_id)</a>
<a name="ln165">                    || (DPS310_REVISION_ID_VAL != ctx-&gt;revision_id))</a>
<a name="ln166">            {</a>
<a name="ln167">                status |= DPS310_UNKNOWN_REV;</a>
<a name="ln168">                ctx-&gt;device_status = DPS310_UNKNOWN_REV;</a>
<a name="ln169">            }</a>
<a name="ln170">        }</a>
<a name="ln171">        else</a>
<a name="ln172">        {</a>
<a name="ln173">            status |= DPS310_BUS_ERROR;</a>
<a name="ln174">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln175">        }</a>
<a name="ln176">    }</a>
<a name="ln177"> </a>
<a name="ln178">    return status;</a>
<a name="ln179">}</a>
<a name="ln180"> </a>
<a name="ln181">// Undocumented workaround for undocumented feature of DPS310, lifted from</a>
<a name="ln182">// DPS310 Arduino driver.</a>
<a name="ln183">// https://github.com/Infineon/DPS310-Pressure-Sensor/blob/888200c7efd8edb19ce69a2144e28ba31cdad449/src/DpsClass.cpp#L448</a>
<a name="ln184">static const dps310_status_t efuse_write (dps310_ctx_t * const ctx)</a>
<a name="ln185">{</a>
<a name="ln186">    dps310_status_t ret_code = ctx_ready_check (ctx);</a>
<a name="ln187"> </a>
<a name="ln188">    if (DPS310_SUCCESS == ret_code)</a>
<a name="ln189">    {</a>
<a name="ln190">        uint8_t regs[5U] =</a>
<a name="ln191">        {</a>
<a name="ln192">            DPS310_EFUSE_0_REG,</a>
<a name="ln193">            DPS310_EFUSE_1_REG,</a>
<a name="ln194">            DPS310_EFUSE_2_REG,</a>
<a name="ln195">            DPS310_EFUSE_0_REG,</a>
<a name="ln196">            DPS310_EFUSE_1_REG</a>
<a name="ln197">        };</a>
<a name="ln198">        uint8_t cmds[5U] =</a>
<a name="ln199">        {</a>
<a name="ln200">            DPS310_EFUSE_0_VAL,</a>
<a name="ln201">            DPS310_EFUSE_1_VAL,</a>
<a name="ln202">            DPS310_EFUSE_2_VAL,</a>
<a name="ln203">            0U,</a>
<a name="ln204">            0U</a>
<a name="ln205">        };</a>
<a name="ln206">        uint8_t cmd_idx = 0U;</a>
<a name="ln207"> </a>
<a name="ln208">        while ( (cmd_idx &lt; sizeof (cmds)) &amp;&amp; (DPS310_SUCCESS == ret_code))</a>
<a name="ln209">        {</a>
<a name="ln210">            ret_code = ctx-&gt;write (ctx-&gt;comm_ctx, regs[cmd_idx], &amp;cmds[cmd_idx], 1U);</a>
<a name="ln211">            cmd_idx++;</a>
<a name="ln212">        }</a>
<a name="ln213"> </a>
<a name="ln214">        if (DPS310_SUCCESS != ret_code)</a>
<a name="ln215">        {</a>
<a name="ln216">            ret_code |= DPS310_BUS_ERROR;</a>
<a name="ln217">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln218">        }</a>
<a name="ln219">    }</a>
<a name="ln220"> </a>
<a name="ln221">    return ret_code;</a>
<a name="ln222">}</a>
<a name="ln223"> </a>
<a name="ln224">dps310_status_t dps310_init (dps310_ctx_t * const ctx)</a>
<a name="ln225">{</a>
<a name="ln226">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln227"> </a>
<a name="ln228">    // ctx_status_check would fail on uninitialized context which isn't purposeful here.</a>
<a name="ln229">    if ( (NULL == ctx)</a>
<a name="ln230">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln231">            || (NULL == ctx-&gt;write)</a>
<a name="ln232">            || (NULL == ctx-&gt;read))</a>
<a name="ln233">    {</a>
<a name="ln234">        err_code = DPS310_ERROR_NULL;</a>
<a name="ln235">    }</a>
<a name="ln236">    else</a>
<a name="ln237">    {</a>
<a name="ln238">        ctx-&gt;sleep (DPS310_POR_DELAY_MS);</a>
<a name="ln239">        err_code |= soft_reset (ctx);</a>
<a name="ln240">        ctx-&gt;sleep (DPS310_COEF_DELAY_MS);</a>
<a name="ln241">        err_code |= read_revision (ctx);</a>
<a name="ln242">        err_code |= efuse_write (ctx);</a>
<a name="ln243">        err_code |= read_coefs (ctx);</a>
<a name="ln244">        err_code |= dps310_config_temp (ctx, DPS310_DEFAULT_MR, DPS310_DEFAULT_OS);</a>
<a name="ln245">        err_code |= dps310_config_pres (ctx, DPS310_DEFAULT_MR, DPS310_DEFAULT_OS);</a>
<a name="ln246">    }</a>
<a name="ln247"> </a>
<a name="ln248">    return err_code;</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251">static dps310_status_t set_mr_reg (uint8_t * const reg, const dps310_mr_t mr)</a>
<a name="ln252">{</a>
<a name="ln253">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln254"> </a>
<a name="ln255">    switch (mr)</a>
<a name="ln256">    {</a>
<a name="ln257">    case DPS310_MR_1:</a>
<a name="ln258">        *reg = 0U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln259">        break;</a>
<a name="ln260"> </a>
<a name="ln261">    case DPS310_MR_2:</a>
<a name="ln262">        *reg = 1U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln263">        break;</a>
<a name="ln264"> </a>
<a name="ln265">    case DPS310_MR_4:</a>
<a name="ln266">        *reg = 2U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln267">        break;</a>
<a name="ln268"> </a>
<a name="ln269">    case DPS310_MR_8:</a>
<a name="ln270">        *reg = 3U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln271">        break;</a>
<a name="ln272"> </a>
<a name="ln273">    case DPS310_MR_16:</a>
<a name="ln274">        *reg = 4U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln275">        break;</a>
<a name="ln276"> </a>
<a name="ln277">    case DPS310_MR_32:</a>
<a name="ln278">        *reg = 5U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln279">        break;</a>
<a name="ln280"> </a>
<a name="ln281">    case DPS310_MR_64:</a>
<a name="ln282">        *reg = 6U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln283">        break;</a>
<a name="ln284"> </a>
<a name="ln285">    case DPS310_MR_128:</a>
<a name="ln286">        *reg = 7U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln287">        break;</a>
<a name="ln288"> </a>
<a name="ln289">    default:</a>
<a name="ln290">        err_code = DPS310_INVALID_PARAM;</a>
<a name="ln291">        break;</a>
<a name="ln292">    }</a>
<a name="ln293"> </a>
<a name="ln294">    return err_code;</a>
<a name="ln295">}</a>
<a name="ln296"> </a>
<a name="ln297">static dps310_status_t set_os_reg (uint8_t * const reg, const dps310_os_t os)</a>
<a name="ln298">{</a>
<a name="ln299">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln300"> </a>
<a name="ln301">    switch (os)</a>
<a name="ln302">    {</a>
<a name="ln303">    case DPS310_OS_1:</a>
<a name="ln304">        *reg = 0U;</a>
<a name="ln305">        break;</a>
<a name="ln306"> </a>
<a name="ln307">    case DPS310_OS_2:</a>
<a name="ln308">        *reg = 1U;</a>
<a name="ln309">        break;</a>
<a name="ln310"> </a>
<a name="ln311">    case DPS310_OS_4:</a>
<a name="ln312">        *reg = 2U;</a>
<a name="ln313">        break;</a>
<a name="ln314"> </a>
<a name="ln315">    case DPS310_OS_8:</a>
<a name="ln316">        *reg = 3U;</a>
<a name="ln317">        break;</a>
<a name="ln318"> </a>
<a name="ln319">    case DPS310_OS_16:</a>
<a name="ln320">        *reg = 4U;</a>
<a name="ln321">        break;</a>
<a name="ln322"> </a>
<a name="ln323">    case DPS310_OS_32:</a>
<a name="ln324">        *reg = 5U;</a>
<a name="ln325">        break;</a>
<a name="ln326"> </a>
<a name="ln327">    case DPS310_OS_64:</a>
<a name="ln328">        *reg = 6U;</a>
<a name="ln329">        break;</a>
<a name="ln330"> </a>
<a name="ln331">    case DPS310_OS_128:</a>
<a name="ln332">        *reg = 7U;</a>
<a name="ln333">        break;</a>
<a name="ln334"> </a>
<a name="ln335">    default:</a>
<a name="ln336">        err_code = DPS310_INVALID_PARAM;</a>
<a name="ln337">        break;</a>
<a name="ln338">    }</a>
<a name="ln339"> </a>
<a name="ln340">    return err_code;</a>
<a name="ln341">}</a>
<a name="ln342"> </a>
<a name="ln343">static dps310_status_t</a>
<a name="ln344">mask_set (const dps310_ctx_t * const ctx, const uint8_t reg_addr, const uint8_t mask)</a>
<a name="ln345">{</a>
<a name="ln346">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln347">    uint8_t reg_val = 0;</a>
<a name="ln348">    err_code |= ctx-&gt;read (ctx-&gt;comm_ctx, reg_addr, &amp;reg_val, 1U);</a>
<a name="ln349">    reg_val |= mask;</a>
<a name="ln350">    err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, reg_addr, &amp;reg_val, 1U);</a>
<a name="ln351">    return err_code;</a>
<a name="ln352">}</a>
<a name="ln353"> </a>
<a name="ln354">dps310_status_t dps310_config_temp (dps310_ctx_t * const ctx, const dps310_mr_t temp_mr,</a>
<a name="ln355">                                    const dps310_os_t temp_osr)</a>
<a name="ln356">{</a>
<a name="ln357">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln358">    uint8_t cmd = 0U;</a>
<a name="ln359"> </a>
<a name="ln360">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln361">    {</a>
<a name="ln362">        err_code |= set_mr_reg (&amp;cmd, temp_mr);</a>
<a name="ln363">        err_code |= set_os_reg (&amp;cmd, temp_osr);</a>
<a name="ln364"> </a>
<a name="ln365">        // TODO: SET coef_src</a>
<a name="ln366">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln367">        {</a>
<a name="ln368">            err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_TEMP_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln369"> </a>
<a name="ln370">            if (temp_osr &gt;= DPS310_OS_16)</a>
<a name="ln371">            {</a>
<a name="ln372">                err_code |=  mask_set (ctx,</a>
<a name="ln373">                                       DPS310_CFG_REG,</a>
<a name="ln374">                                       DPS310_CFG_TEMPSH_MASK);</a>
<a name="ln375">            }</a>
<a name="ln376"> </a>
<a name="ln377">            if (DPS310_SUCCESS == err_code)</a>
<a name="ln378">            {</a>
<a name="ln379">                ctx-&gt;temp_mr = temp_mr;</a>
<a name="ln380">                ctx-&gt;temp_osr = temp_osr;</a>
<a name="ln381">            }</a>
<a name="ln382">            else</a>
<a name="ln383">            {</a>
<a name="ln384">                err_code |= DPS310_BUS_ERROR;</a>
<a name="ln385">                ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln386">            }</a>
<a name="ln387">        }</a>
<a name="ln388">    }</a>
<a name="ln389"> </a>
<a name="ln390">    return err_code;</a>
<a name="ln391">}</a>
<a name="ln392"> </a>
<a name="ln393">dps310_status_t dps310_config_pres (dps310_ctx_t * const ctx, const dps310_mr_t pres_mr,</a>
<a name="ln394">                                    const dps310_os_t pres_osr)</a>
<a name="ln395">{</a>
<a name="ln396">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln397">    uint8_t cmd = 0U;</a>
<a name="ln398"> </a>
<a name="ln399">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln400">    {</a>
<a name="ln401">        err_code |= set_mr_reg (&amp;cmd, pres_mr);</a>
<a name="ln402">        err_code |= set_os_reg (&amp;cmd, pres_osr);</a>
<a name="ln403"> </a>
<a name="ln404">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln405">        {</a>
<a name="ln406">            err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_PRES_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln407"> </a>
<a name="ln408">            if (DPS310_SUCCESS == err_code)</a>
<a name="ln409">            {</a>
<a name="ln410">                ctx-&gt;pres_mr = pres_mr;</a>
<a name="ln411">                ctx-&gt;pres_osr = pres_osr;</a>
<a name="ln412">            }</a>
<a name="ln413">            else</a>
<a name="ln414">            {</a>
<a name="ln415">                err_code |= DPS310_BUS_ERROR;</a>
<a name="ln416">                ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln417">            }</a>
<a name="ln418">        }</a>
<a name="ln419">    }</a>
<a name="ln420"> </a>
<a name="ln421">    return err_code;</a>
<a name="ln422">}</a>
<a name="ln423"> </a>
<a name="ln424">dps310_status_t dps310_measure_continuous_async (dps310_ctx_t * const ctx)</a>
<a name="ln425">{</a>
<a name="ln426">    return DPS310_NOT_IMPLEMENTED;</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429">dps310_status_t dps310_standby (dps310_ctx_t * const ctx)</a>
<a name="ln430">{</a>
<a name="ln431">    dps310_status_t err_code = ctx_status_check (ctx);</a>
<a name="ln432"> </a>
<a name="ln433">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln434">    {</a>
<a name="ln435">        uint8_t cmd = DPS310_MODE_STANDBY_VAL;</a>
<a name="ln436">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_MEAS_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln437"> </a>
<a name="ln438">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln439">        {</a>
<a name="ln440">            ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln441">        }</a>
<a name="ln442">        else</a>
<a name="ln443">        {</a>
<a name="ln444">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln445">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln446">        }</a>
<a name="ln447">    }</a>
<a name="ln448"> </a>
<a name="ln449">    return err_code;</a>
<a name="ln450">}</a>
<a name="ln451"> </a>
<a name="ln452">static uint8_t os_to_num (const dps310_os_t os)</a>
<a name="ln453">{</a>
<a name="ln454">    uint8_t num = 0;</a>
<a name="ln455"> </a>
<a name="ln456">    switch (os)</a>
<a name="ln457">    {</a>
<a name="ln458">    case DPS310_OS_1:</a>
<a name="ln459">        num = 1U;</a>
<a name="ln460">        break;</a>
<a name="ln461"> </a>
<a name="ln462">    case DPS310_OS_2:</a>
<a name="ln463">        num = 2U;</a>
<a name="ln464">        break;</a>
<a name="ln465"> </a>
<a name="ln466">    case DPS310_OS_4:</a>
<a name="ln467">        num = 4U;</a>
<a name="ln468">        break;</a>
<a name="ln469"> </a>
<a name="ln470">    case DPS310_OS_8:</a>
<a name="ln471">        num = 8U;</a>
<a name="ln472">        break;</a>
<a name="ln473"> </a>
<a name="ln474">    case DPS310_OS_16:</a>
<a name="ln475">        num = 16U;</a>
<a name="ln476">        break;</a>
<a name="ln477"> </a>
<a name="ln478">    case DPS310_OS_32:</a>
<a name="ln479">        num = 32U;</a>
<a name="ln480">        break;</a>
<a name="ln481"> </a>
<a name="ln482">    case DPS310_OS_64:</a>
<a name="ln483">        num = 64U;</a>
<a name="ln484">        break;</a>
<a name="ln485"> </a>
<a name="ln486">    case DPS310_OS_128:</a>
<a name="ln487">        num = 128U;</a>
<a name="ln488">        break;</a>
<a name="ln489"> </a>
<a name="ln490">    default:</a>
<a name="ln491">        num = 0;</a>
<a name="ln492">        break;</a>
<a name="ln493">    }</a>
<a name="ln494"> </a>
<a name="ln495">    return num;</a>
<a name="ln496">}</a>
<a name="ln497"> </a>
<a name="ln498">uint32_t temp_measurement_time_get (const dps310_ctx_t * const ctx)</a>
<a name="ln499">{</a>
<a name="ln500">    // Actually 2 + 1.6 * OSR, but rounding up.</a>
<a name="ln501">    return 3U + (uint32_t) (1.6F * (float) os_to_num (ctx-&gt;temp_osr));</a>
<a name="ln502">}</a>
<a name="ln503"> </a>
<a name="ln504"> </a>
<a name="ln505">dps310_status_t dps310_measure_temp_once_sync (dps310_ctx_t * const ctx,</a>
<a name="ln506">        float * const result)</a>
<a name="ln507">{</a>
<a name="ln508">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln509"> </a>
<a name="ln510">    if (NULL == result)</a>
<a name="ln511">    {</a>
<a name="ln512">        err_code = DPS310_ERROR_NULL;</a>
<a name="ln513">    }</a>
<a name="ln514">    else if (DPS310_SUCCESS == err_code)</a>
<a name="ln515">    {</a>
<a name="ln516">        err_code |= dps310_measure_temp_once_async (ctx);</a>
<a name="ln517">        ctx-&gt;sleep (temp_measurement_time_get (ctx));</a>
<a name="ln518">        err_code |= dps310_get_single_result (ctx, result);</a>
<a name="ln519">    }</a>
<a name="ln520">    else</a>
<a name="ln521">    {</a>
<a name="ln522">        // No action needed.</a>
<a name="ln523">    }</a>
<a name="ln524"> </a>
<a name="ln525">    return err_code;</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528">dps310_status_t dps310_measure_temp_once_async (dps310_ctx_t * const ctx)</a>
<a name="ln529">{</a>
<a name="ln530">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln531"> </a>
<a name="ln532">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln533">    {</a>
<a name="ln534">        uint8_t cmd = DPS310_MODE_ONE_TEMP_VAL;</a>
<a name="ln535">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_MEAS_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln536"> </a>
<a name="ln537">        if (DPS310_SUCCESS != err_code)</a>
<a name="ln538">        {</a>
<a name="ln539">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln540">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln541">        }</a>
<a name="ln542">    }</a>
<a name="ln543"> </a>
<a name="ln544">    return err_code;</a>
<a name="ln545">}</a>
<a name="ln546"> </a>
<a name="ln547">// Datasheet 4.9.3</a>
<a name="ln548">static uint32_t os_to_scale_factor (const dps310_os_t os)</a>
<a name="ln549">{</a>
<a name="ln550">    uint32_t sf = 0;</a>
<a name="ln551"> </a>
<a name="ln552">    switch (os)</a>
<a name="ln553">    {</a>
<a name="ln554">    case DPS310_OS_1:</a>
<a name="ln555">        sf = 524288U;</a>
<a name="ln556">        break;</a>
<a name="ln557"> </a>
<a name="ln558">    case DPS310_OS_2:</a>
<a name="ln559">        sf = 1572864U;</a>
<a name="ln560">        break;</a>
<a name="ln561"> </a>
<a name="ln562">    case DPS310_OS_4:</a>
<a name="ln563">        sf = 3670016U;</a>
<a name="ln564">        break;</a>
<a name="ln565"> </a>
<a name="ln566">    case DPS310_OS_8:</a>
<a name="ln567">        sf = 7864320U;</a>
<a name="ln568">        break;</a>
<a name="ln569"> </a>
<a name="ln570">    case DPS310_OS_16:</a>
<a name="ln571">        sf = 253952U;</a>
<a name="ln572">        break;</a>
<a name="ln573"> </a>
<a name="ln574">    case DPS310_OS_32:</a>
<a name="ln575">        sf = 516096U;</a>
<a name="ln576">        break;</a>
<a name="ln577"> </a>
<a name="ln578">    case DPS310_OS_64:</a>
<a name="ln579">        sf = 1040384U;</a>
<a name="ln580">        break;</a>
<a name="ln581"> </a>
<a name="ln582">    case DPS310_OS_128:</a>
<a name="ln583">        sf = 2088960U;</a>
<a name="ln584">        break;</a>
<a name="ln585"> </a>
<a name="ln586">    default:</a>
<a name="ln587">        sf = 1;</a>
<a name="ln588">        break;</a>
<a name="ln589">    }</a>
<a name="ln590"> </a>
<a name="ln591">    return sf;</a>
<a name="ln592">}</a>
<a name="ln593"> </a>
<a name="ln594">static float calculate_temperature (dps310_ctx_t * const ctx, const int32_t raw)</a>
<a name="ln595">{</a>
<a name="ln596">    uint32_t sf = os_to_scale_factor (ctx-&gt;temp_osr);</a>
<a name="ln597">    float raw_scaled = ( (float) raw) / ( (float) sf);</a>
<a name="ln598">    ctx-&gt;last_temp_scal = raw_scaled;</a>
<a name="ln599">    return ( (float) ctx-&gt;c0 * DPS310_C0_WEIGHT) + ( (float) ctx-&gt;c1 * raw_scaled);</a>
<a name="ln600">}</a>
<a name="ln601"> </a>
<a name="ln602">dps310_status_t dps310_get_single_result (dps310_ctx_t * const ctx, float * const result)</a>
<a name="ln603">{</a>
<a name="ln604">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln605"> </a>
<a name="ln606">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln607">    {</a>
<a name="ln608">        uint8_t reg_value[DPS310_TEMP_VAL_LEN] = {0};</a>
<a name="ln609">        err_code |= ctx-&gt;read (ctx-&gt;comm_ctx,</a>
<a name="ln610">                               DPS310_TEMP_VAL_REG,</a>
<a name="ln611">                               reg_value,</a>
<a name="ln612">                               DPS310_TEMP_VAL_LEN);</a>
<a name="ln613"> </a>
<a name="ln614">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln615">        {</a>
<a name="ln616">            uint32_t b24_value = (reg_value[0U] &lt;&lt; 16U)</a>
<a name="ln617">                                 + (reg_value[1U] &lt;&lt; 8U)</a>
<a name="ln618">                                 + reg_value[2U];</a>
<a name="ln619">            int32_t raw_value = twos_complement (b24_value, 24U);</a>
<a name="ln620">            *result = calculate_temperature (ctx, raw_value);</a>
<a name="ln621">        }</a>
<a name="ln622">        else</a>
<a name="ln623">        {</a>
<a name="ln624">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln625">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln626">        }</a>
<a name="ln627">    }</a>
<a name="ln628"> </a>
<a name="ln629">    return err_code;</a>
<a name="ln630">}</a>
<a name="ln631"> </a>
<a name="ln632">/** @} */</a>

</code></pre>
<div class="balloon" rel="133"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0x09U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="160"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'revision[0U] & (0x0FU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="161"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(revision[0U] & (0xF0U)) >> (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="262"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="266"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="270"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '3U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="274"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="278"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '5U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="282"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '6U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="286"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '7U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="308"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="312"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="316"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '3U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="320"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="324"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '5U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="328"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '6U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="332"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '7U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="459"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="463"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="467"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="471"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '8U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="475"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '16U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="479"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '32U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="483"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '64U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="487"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '128U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="491"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="501"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'float' type to unsigned integer type.</p></div>
<div class="balloon" rel="534"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0x02U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="587"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="616"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="616"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
