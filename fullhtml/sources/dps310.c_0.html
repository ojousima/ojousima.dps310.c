
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>dps310.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @addtogroup DPS310</a>
<a name="ln3"> *</a>
<a name="ln4"> */</a>
<a name="ln5">/** @{ */</a>
<a name="ln6">/** @file dps310.c</a>
<a name="ln7"> *</a>
<a name="ln8"> * @brief Implementation of DPS310 driver</a>
<a name="ln9"> * @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln10"> * @date 2020-12-07</a>
<a name="ln11"> * @copyright Ruuvi Innovations, License MIT.</a>
<a name="ln12"> *</a>
<a name="ln13"> */</a>
<a name="ln14"> </a>
<a name="ln15">#include &quot;dps310.h&quot;</a>
<a name="ln16">#include &quot;dps310_reg.h&quot;</a>
<a name="ln17">#include &lt;stdbool.h&gt;</a>
<a name="ln18">#include &lt;stddef.h&gt;</a>
<a name="ln19"> </a>
<a name="ln20">// Valid up to 31 bits</a>
<a name="ln21">static int32_t twos_complement (const uint32_t value, const uint8_t bits)</a>
<a name="ln22">{</a>
<a name="ln23">    const int32_t max_signed_value_exclusive = (int32_t) (1U &lt;&lt; (bits - 1U));</a>
<a name="ln24">    int32_t complement = (int32_t) value;</a>
<a name="ln25"> </a>
<a name="ln26">    if (complement &gt;= max_signed_value_exclusive)</a>
<a name="ln27">    {</a>
<a name="ln28">        complement -= 2 * max_signed_value_exclusive;</a>
<a name="ln29">    }</a>
<a name="ln30"> </a>
<a name="ln31">    return complement;</a>
<a name="ln32">}</a>
<a name="ln33"> </a>
<a name="ln34">static dps310_status_t ctx_status_check (const dps310_ctx_t * const ctx)</a>
<a name="ln35">{</a>
<a name="ln36">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln37"> </a>
<a name="ln38">    if ( (NULL == ctx)</a>
<a name="ln39">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln40">            || (NULL == ctx-&gt;write)</a>
<a name="ln41">            || (NULL == ctx-&gt;read))</a>
<a name="ln42">    {</a>
<a name="ln43">        status = DPS310_ERROR_NULL;</a>
<a name="ln44">    }</a>
<a name="ln45">    else if (ctx-&gt;device_status &gt; DPS310_MAX_OK)</a>
<a name="ln46">    {</a>
<a name="ln47">        status = ctx-&gt;device_status;</a>
<a name="ln48">    }</a>
<a name="ln49">    else if (DPS310_NOT_INITIALIZED == ctx-&gt;device_status)</a>
<a name="ln50">    {</a>
<a name="ln51">        status = DPS310_INVALID_STATE;</a>
<a name="ln52">    }</a>
<a name="ln53">    else</a>
<a name="ln54">    {</a>
<a name="ln55">        // No action needed.</a>
<a name="ln56">    }</a>
<a name="ln57"> </a>
<a name="ln58">    return status;</a>
<a name="ln59">}</a>
<a name="ln60"> </a>
<a name="ln61">static dps310_status_t ctx_ready_check (const dps310_ctx_t * const ctx)</a>
<a name="ln62">{</a>
<a name="ln63">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln64"> </a>
<a name="ln65">    if ( (NULL == ctx)</a>
<a name="ln66">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln67">            || (NULL == ctx-&gt;write)</a>
<a name="ln68">            || (NULL == ctx-&gt;read))</a>
<a name="ln69">    {</a>
<a name="ln70">        status = DPS310_ERROR_NULL;</a>
<a name="ln71">    }</a>
<a name="ln72">    // Bus error code must be returned as-is to application.</a>
<a name="ln73">    else if (DPS310_BUS_ERROR == ctx-&gt;device_status)</a>
<a name="ln74">    {</a>
<a name="ln75">        status = DPS310_BUS_ERROR;</a>
<a name="ln76">    }</a>
<a name="ln77">    // Other states can be interpreted as invalid state.</a>
<a name="ln78">    else if (DPS310_READY != ctx-&gt;device_status)</a>
<a name="ln79">    {</a>
<a name="ln80">        status = DPS310_INVALID_STATE;</a>
<a name="ln81">    }</a>
<a name="ln82">    else</a>
<a name="ln83">    {</a>
<a name="ln84">        // No action needed.</a>
<a name="ln85">    }</a>
<a name="ln86"> </a>
<a name="ln87">    return status;</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">static dps310_status_t ctx_cont_check (const dps310_ctx_t * const ctx)</a>
<a name="ln91">{</a>
<a name="ln92">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln93"> </a>
<a name="ln94">    if ( (NULL == ctx)</a>
<a name="ln95">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln96">            || (NULL == ctx-&gt;write)</a>
<a name="ln97">            || (NULL == ctx-&gt;read))</a>
<a name="ln98">    {</a>
<a name="ln99">        status = DPS310_ERROR_NULL;</a>
<a name="ln100">    }</a>
<a name="ln101">    // Bus error code must be returned as-is to application.</a>
<a name="ln102">    else if (DPS310_BUS_ERROR == ctx-&gt;device_status)</a>
<a name="ln103">    {</a>
<a name="ln104">        status = DPS310_BUS_ERROR;</a>
<a name="ln105">    }</a>
<a name="ln106">    // Other states can be interpreted as invalid state.</a>
<a name="ln107">    else if (DPS310_CONTINUOUS != ctx-&gt;device_status)</a>
<a name="ln108">    {</a>
<a name="ln109">        status = DPS310_INVALID_STATE;</a>
<a name="ln110">    }</a>
<a name="ln111">    else</a>
<a name="ln112">    {</a>
<a name="ln113">        // No action needed.</a>
<a name="ln114">    }</a>
<a name="ln115"> </a>
<a name="ln116">    return status;</a>
<a name="ln117">}</a>
<a name="ln118"> </a>
<a name="ln119">static dps310_status_t ctx_done_check (const dps310_ctx_t * const ctx)</a>
<a name="ln120">{</a>
<a name="ln121">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln122"> </a>
<a name="ln123">    if ( (NULL == ctx)</a>
<a name="ln124">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln125">            || (NULL == ctx-&gt;write)</a>
<a name="ln126">            || (NULL == ctx-&gt;read))</a>
<a name="ln127">    {</a>
<a name="ln128">        status = DPS310_ERROR_NULL;</a>
<a name="ln129">    }</a>
<a name="ln130">    // Bus error code must be returned as-is to application.</a>
<a name="ln131">    else if (DPS310_BUS_ERROR == ctx-&gt;device_status)</a>
<a name="ln132">    {</a>
<a name="ln133">        status = DPS310_BUS_ERROR;</a>
<a name="ln134">    }</a>
<a name="ln135">    // Other states can be interpreted as invalid state.</a>
<a name="ln136">    else if ( (DPS310_TEMP_RDY != ctx-&gt;device_status)</a>
<a name="ln137">              &amp;&amp; (DPS310_PRES_RDY != ctx-&gt;device_status))</a>
<a name="ln138">    {</a>
<a name="ln139">        status = DPS310_INVALID_STATE;</a>
<a name="ln140">    }</a>
<a name="ln141">    else</a>
<a name="ln142">    {</a>
<a name="ln143">        // No action needed.</a>
<a name="ln144">    }</a>
<a name="ln145"> </a>
<a name="ln146">    return status;</a>
<a name="ln147">}</a>
<a name="ln148"> </a>
<a name="ln149">static dps310_status_t read_coefs (dps310_ctx_t * const ctx)</a>
<a name="ln150">{</a>
<a name="ln151">    uint8_t coefs[DPS310_COEF_REG_LEN] = {0};</a>
<a name="ln152">    dps310_status_t reg_read_ret = ctx-&gt;read (ctx-&gt;comm_ctx, DPS310_COEF_START_REG,</a>
<a name="ln153">                                   coefs, DPS310_COEF_REG_LEN);</a>
<a name="ln154">    uint32_t reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C0_OFFSET] * 256U)</a>
<a name="ln155">                         + ( (uint32_t) coefs[DPS310_COEF_C0_OFFSET + 1U]))</a>
<a name="ln156">                       &gt;&gt; DPS310_COEF_C0_SHIFT;</a>
<a name="ln157">    ctx-&gt;c0 = twos_complement (reg_val, DPS310_COEF_C0_LEN_BITS);</a>
<a name="ln158">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C1_OFFSET] * 256U)</a>
<a name="ln159">                + ( (uint32_t) coefs[DPS310_COEF_C1_OFFSET + 1U]))</a>
<a name="ln160">              &amp; ( (1U &lt;&lt; DPS310_COEF_C1_LEN_BITS) - 1U);</a>
<a name="ln161">    ctx-&gt;c1 = twos_complement (reg_val, DPS310_COEF_C1_LEN_BITS);</a>
<a name="ln162">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET] * 256U * 256U)</a>
<a name="ln163">                + ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET + 1U] * 256U)</a>
<a name="ln164">                + ( (uint32_t) coefs[DPS310_COEF_C00_OFFSET + 2U]))</a>
<a name="ln165">              &gt;&gt; DPS310_COEF_C00_SHIFT;</a>
<a name="ln166">    ctx-&gt;c00 = twos_complement (reg_val, DPS310_COEF_C00_LEN_BITS);</a>
<a name="ln167">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET] * 256U * 256U)</a>
<a name="ln168">                + ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET + 1U] * 256U)</a>
<a name="ln169">                + ( (uint32_t) coefs[DPS310_COEF_C10_OFFSET + 2U]))</a>
<a name="ln170">              &amp; ( (1U &lt;&lt; DPS310_COEF_C10_LEN_BITS) - 1U);</a>
<a name="ln171">    ctx-&gt;c10 = twos_complement (reg_val, DPS310_COEF_C10_LEN_BITS);</a>
<a name="ln172">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C01_OFFSET] * 256U)</a>
<a name="ln173">                + ( (uint32_t) coefs[DPS310_COEF_C01_OFFSET + 1U]));</a>
<a name="ln174">    ctx-&gt;c01 = twos_complement (reg_val, DPS310_COEF_C01_LEN_BITS);</a>
<a name="ln175">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C11_OFFSET] * 256U)</a>
<a name="ln176">                + ( (uint32_t) coefs[DPS310_COEF_C11_OFFSET + 1U]));</a>
<a name="ln177">    ctx-&gt;c11 = twos_complement (reg_val, DPS310_COEF_C01_LEN_BITS);</a>
<a name="ln178">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C20_OFFSET] * 256U)</a>
<a name="ln179">                + ( (uint32_t) coefs[DPS310_COEF_C20_OFFSET + 1U]));</a>
<a name="ln180">    ctx-&gt;c20 = twos_complement (reg_val, DPS310_COEF_C20_LEN_BITS);</a>
<a name="ln181">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C21_OFFSET] * 256U)</a>
<a name="ln182">                + ( (uint32_t) coefs[DPS310_COEF_C21_OFFSET + 1U]));</a>
<a name="ln183">    ctx-&gt;c21 = twos_complement (reg_val, DPS310_COEF_C21_LEN_BITS);</a>
<a name="ln184">    reg_val = ( ( (uint32_t) coefs[DPS310_COEF_C30_OFFSET] * 256U)</a>
<a name="ln185">                + ( (uint32_t) coefs[DPS310_COEF_C30_OFFSET + 1U]));</a>
<a name="ln186">    ctx-&gt;c30 = twos_complement (reg_val, DPS310_COEF_C30_LEN_BITS);</a>
<a name="ln187">    return reg_read_ret;</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">static dps310_status_t soft_reset (dps310_ctx_t * const ctx)</a>
<a name="ln191">{</a>
<a name="ln192">    dps310_status_t status = DPS310_SUCCESS;</a>
<a name="ln193">    uint8_t cmd = DPS310_SOFT_RST_VAL;</a>
<a name="ln194">    status |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_RST_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln195"> </a>
<a name="ln196">    if (DPS310_SUCCESS == status)</a>
<a name="ln197">    {</a>
<a name="ln198">        ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln199">    }</a>
<a name="ln200">    else</a>
<a name="ln201">    {</a>
<a name="ln202">        status |= DPS310_BUS_ERROR;</a>
<a name="ln203">        ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln204">    }</a>
<a name="ln205"> </a>
<a name="ln206">    return status;</a>
<a name="ln207">}</a>
<a name="ln208"> </a>
<a name="ln209">static dps310_status_t read_revision (dps310_ctx_t * const ctx)</a>
<a name="ln210">{</a>
<a name="ln211">    dps310_status_t status = ctx_ready_check (ctx);</a>
<a name="ln212">    uint8_t revision[1U] = {0xFFU};</a>
<a name="ln213"> </a>
<a name="ln214">    if (DPS310_SUCCESS == status)</a>
<a name="ln215">    {</a>
<a name="ln216">        status |= ctx-&gt;read (ctx-&gt;comm_ctx, DPS310_PROD_ID_REG, revision, 1U);</a>
<a name="ln217"> </a>
<a name="ln218">        if (DPS310_SUCCESS == status)</a>
<a name="ln219">        {</a>
<a name="ln220">            ctx-&gt;product_id = revision[0U]  &amp; DPS310_PROD_ID_MASK;</a>
<a name="ln221">            ctx-&gt;revision_id = (revision[0U] &amp; DPS310_PROD_ID_REV_MASK)</a>
<a name="ln222">                               &gt;&gt; DPS310_PROD_ID_REV_SHIFT;</a>
<a name="ln223"> </a>
<a name="ln224">            if ( (DPS310_PRODUCT_ID_VAL != ctx-&gt;product_id)</a>
<a name="ln225">                    || (DPS310_REVISION_ID_VAL != ctx-&gt;revision_id))</a>
<a name="ln226">            {</a>
<a name="ln227">                status |= DPS310_UNKNOWN_REV;</a>
<a name="ln228">                ctx-&gt;device_status = DPS310_UNKNOWN_REV;</a>
<a name="ln229">            }</a>
<a name="ln230">        }</a>
<a name="ln231">        else</a>
<a name="ln232">        {</a>
<a name="ln233">            status |= DPS310_BUS_ERROR;</a>
<a name="ln234">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln235">        }</a>
<a name="ln236">    }</a>
<a name="ln237"> </a>
<a name="ln238">    return status;</a>
<a name="ln239">}</a>
<a name="ln240"> </a>
<a name="ln241">// Undocumented workaround for undocumented feature of DPS310, lifted from</a>
<a name="ln242">// DPS310 Arduino driver.</a>
<a name="ln243">// https://github.com/Infineon/DPS310-Pressure-Sensor/blob/888200c7efd8edb19ce69a2144e28ba31cdad449/src/DpsClass.cpp#L448</a>
<a name="ln244">static const dps310_status_t efuse_write (dps310_ctx_t * const ctx)</a>
<a name="ln245">{</a>
<a name="ln246">    dps310_status_t ret_code = ctx_ready_check (ctx);</a>
<a name="ln247"> </a>
<a name="ln248">    if (DPS310_SUCCESS == ret_code)</a>
<a name="ln249">    {</a>
<a name="ln250">        uint8_t regs[5U] =</a>
<a name="ln251">        {</a>
<a name="ln252">            DPS310_EFUSE_0_REG,</a>
<a name="ln253">            DPS310_EFUSE_1_REG,</a>
<a name="ln254">            DPS310_EFUSE_2_REG,</a>
<a name="ln255">            DPS310_EFUSE_0_REG,</a>
<a name="ln256">            DPS310_EFUSE_1_REG</a>
<a name="ln257">        };</a>
<a name="ln258">        uint8_t cmds[5U] =</a>
<a name="ln259">        {</a>
<a name="ln260">            DPS310_EFUSE_0_VAL,</a>
<a name="ln261">            DPS310_EFUSE_1_VAL,</a>
<a name="ln262">            DPS310_EFUSE_2_VAL,</a>
<a name="ln263">            0U,</a>
<a name="ln264">            0U</a>
<a name="ln265">        };</a>
<a name="ln266">        uint8_t cmd_idx = 0U;</a>
<a name="ln267"> </a>
<a name="ln268">        while ( (cmd_idx &lt; sizeof (cmds)) &amp;&amp; (DPS310_SUCCESS == ret_code))</a>
<a name="ln269">        {</a>
<a name="ln270">            ret_code = ctx-&gt;write (ctx-&gt;comm_ctx, regs[cmd_idx], &amp;cmds[cmd_idx], 1U);</a>
<a name="ln271">            cmd_idx++;</a>
<a name="ln272">        }</a>
<a name="ln273"> </a>
<a name="ln274">        if (DPS310_SUCCESS != ret_code)</a>
<a name="ln275">        {</a>
<a name="ln276">            ret_code |= DPS310_BUS_ERROR;</a>
<a name="ln277">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln278">        }</a>
<a name="ln279">    }</a>
<a name="ln280"> </a>
<a name="ln281">    return ret_code;</a>
<a name="ln282">}</a>
<a name="ln283"> </a>
<a name="ln284">dps310_status_t dps310_init (dps310_ctx_t * const ctx)</a>
<a name="ln285">{</a>
<a name="ln286">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln287"> </a>
<a name="ln288">    // ctx_status_check would fail on uninitialized context which isn't purposeful here.</a>
<a name="ln289">    if ( (NULL == ctx)</a>
<a name="ln290">            || (NULL == ctx-&gt;sleep)</a>
<a name="ln291">            || (NULL == ctx-&gt;write)</a>
<a name="ln292">            || (NULL == ctx-&gt;read))</a>
<a name="ln293">    {</a>
<a name="ln294">        err_code = DPS310_ERROR_NULL;</a>
<a name="ln295">    }</a>
<a name="ln296">    else</a>
<a name="ln297">    {</a>
<a name="ln298">        ctx-&gt;sleep (DPS310_POR_DELAY_MS);</a>
<a name="ln299">        err_code |= soft_reset (ctx);</a>
<a name="ln300">        ctx-&gt;sleep (DPS310_COEF_DELAY_MS);</a>
<a name="ln301">        err_code |= read_revision (ctx);</a>
<a name="ln302">        err_code |= efuse_write (ctx);</a>
<a name="ln303">        err_code |= read_coefs (ctx);</a>
<a name="ln304">        err_code |= dps310_config_temp (ctx, DPS310_DEFAULT_MR, DPS310_DEFAULT_OS);</a>
<a name="ln305">        err_code |= dps310_config_pres (ctx, DPS310_DEFAULT_MR, DPS310_DEFAULT_OS);</a>
<a name="ln306">    }</a>
<a name="ln307"> </a>
<a name="ln308">    return err_code;</a>
<a name="ln309">}</a>
<a name="ln310"> </a>
<a name="ln311">static dps310_status_t set_mr_reg (uint8_t * const reg, const dps310_mr_t mr)</a>
<a name="ln312">{</a>
<a name="ln313">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln314"> </a>
<a name="ln315">    switch (mr)</a>
<a name="ln316">    {</a>
<a name="ln317">    case DPS310_MR_1:</a>
<a name="ln318">        *reg = 0U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln319">        break;</a>
<a name="ln320"> </a>
<a name="ln321">    case DPS310_MR_2:</a>
<a name="ln322">        *reg = 1U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln323">        break;</a>
<a name="ln324"> </a>
<a name="ln325">    case DPS310_MR_4:</a>
<a name="ln326">        *reg = 2U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln327">        break;</a>
<a name="ln328"> </a>
<a name="ln329">    case DPS310_MR_8:</a>
<a name="ln330">        *reg = 3U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln331">        break;</a>
<a name="ln332"> </a>
<a name="ln333">    case DPS310_MR_16:</a>
<a name="ln334">        *reg = 4U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln335">        break;</a>
<a name="ln336"> </a>
<a name="ln337">    case DPS310_MR_32:</a>
<a name="ln338">        *reg = 5U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln339">        break;</a>
<a name="ln340"> </a>
<a name="ln341">    case DPS310_MR_64:</a>
<a name="ln342">        *reg = 6U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln343">        break;</a>
<a name="ln344"> </a>
<a name="ln345">    case DPS310_MR_128:</a>
<a name="ln346">        *reg = 7U &lt;&lt; DPS310_MR_SHIFT;</a>
<a name="ln347">        break;</a>
<a name="ln348"> </a>
<a name="ln349">    default:</a>
<a name="ln350">        err_code = DPS310_INVALID_PARAM;</a>
<a name="ln351">        break;</a>
<a name="ln352">    }</a>
<a name="ln353"> </a>
<a name="ln354">    return err_code;</a>
<a name="ln355">}</a>
<a name="ln356"> </a>
<a name="ln357">static dps310_status_t set_os_reg (uint8_t * const reg, const dps310_os_t os)</a>
<a name="ln358">{</a>
<a name="ln359">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln360"> </a>
<a name="ln361">    switch (os)</a>
<a name="ln362">    {</a>
<a name="ln363">    case DPS310_OS_1:</a>
<a name="ln364">        *reg = 0U;</a>
<a name="ln365">        break;</a>
<a name="ln366"> </a>
<a name="ln367">    case DPS310_OS_2:</a>
<a name="ln368">        *reg = 1U;</a>
<a name="ln369">        break;</a>
<a name="ln370"> </a>
<a name="ln371">    case DPS310_OS_4:</a>
<a name="ln372">        *reg = 2U;</a>
<a name="ln373">        break;</a>
<a name="ln374"> </a>
<a name="ln375">    case DPS310_OS_8:</a>
<a name="ln376">        *reg = 3U;</a>
<a name="ln377">        break;</a>
<a name="ln378"> </a>
<a name="ln379">    case DPS310_OS_16:</a>
<a name="ln380">        *reg = 4U;</a>
<a name="ln381">        break;</a>
<a name="ln382"> </a>
<a name="ln383">    case DPS310_OS_32:</a>
<a name="ln384">        *reg = 5U;</a>
<a name="ln385">        break;</a>
<a name="ln386"> </a>
<a name="ln387">    case DPS310_OS_64:</a>
<a name="ln388">        *reg = 6U;</a>
<a name="ln389">        break;</a>
<a name="ln390"> </a>
<a name="ln391">    case DPS310_OS_128:</a>
<a name="ln392">        *reg = 7U;</a>
<a name="ln393">        break;</a>
<a name="ln394"> </a>
<a name="ln395">    default:</a>
<a name="ln396">        err_code = DPS310_INVALID_PARAM;</a>
<a name="ln397">        break;</a>
<a name="ln398">    }</a>
<a name="ln399"> </a>
<a name="ln400">    return err_code;</a>
<a name="ln401">}</a>
<a name="ln402"> </a>
<a name="ln403">static dps310_status_t</a>
<a name="ln404">mask_set (const dps310_ctx_t * const ctx, const uint8_t reg_addr, const uint8_t mask)</a>
<a name="ln405">{</a>
<a name="ln406">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln407">    uint8_t reg_val = 0;</a>
<a name="ln408">    err_code |= ctx-&gt;read (ctx-&gt;comm_ctx, reg_addr, &amp;reg_val, 1U);</a>
<a name="ln409">    reg_val |= mask;</a>
<a name="ln410">    err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, reg_addr, &amp;reg_val, 1U);</a>
<a name="ln411">    return err_code;</a>
<a name="ln412">}</a>
<a name="ln413"> </a>
<a name="ln414">dps310_status_t dps310_config_temp (dps310_ctx_t * const ctx, const dps310_mr_t temp_mr,</a>
<a name="ln415">                                    const dps310_os_t temp_osr)</a>
<a name="ln416">{</a>
<a name="ln417">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln418">    uint8_t cmd = 0U;</a>
<a name="ln419"> </a>
<a name="ln420">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln421">    {</a>
<a name="ln422">        err_code |= set_mr_reg (&amp;cmd, temp_mr);</a>
<a name="ln423">        err_code |= set_os_reg (&amp;cmd, temp_osr);</a>
<a name="ln424"> </a>
<a name="ln425">        // TODO: SET coef_src</a>
<a name="ln426">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln427">        {</a>
<a name="ln428">            err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_TEMP_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln429"> </a>
<a name="ln430">            if (temp_osr &gt;= DPS310_OS_16)</a>
<a name="ln431">            {</a>
<a name="ln432">                err_code |=  mask_set (ctx,</a>
<a name="ln433">                                       DPS310_CFG_REG,</a>
<a name="ln434">                                       DPS310_CFG_TEMPSH_MASK);</a>
<a name="ln435">            }</a>
<a name="ln436"> </a>
<a name="ln437">            if (DPS310_SUCCESS == err_code)</a>
<a name="ln438">            {</a>
<a name="ln439">                ctx-&gt;temp_mr = temp_mr;</a>
<a name="ln440">                ctx-&gt;temp_osr = temp_osr;</a>
<a name="ln441">            }</a>
<a name="ln442">            else</a>
<a name="ln443">            {</a>
<a name="ln444">                err_code |= DPS310_BUS_ERROR;</a>
<a name="ln445">                ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln446">            }</a>
<a name="ln447">        }</a>
<a name="ln448">    }</a>
<a name="ln449"> </a>
<a name="ln450">    return err_code;</a>
<a name="ln451">}</a>
<a name="ln452"> </a>
<a name="ln453">dps310_status_t dps310_config_pres (dps310_ctx_t * const ctx, const dps310_mr_t pres_mr,</a>
<a name="ln454">                                    const dps310_os_t pres_osr)</a>
<a name="ln455">{</a>
<a name="ln456">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln457">    uint8_t cmd = 0U;</a>
<a name="ln458"> </a>
<a name="ln459">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln460">    {</a>
<a name="ln461">        err_code |= set_mr_reg (&amp;cmd, pres_mr);</a>
<a name="ln462">        err_code |= set_os_reg (&amp;cmd, pres_osr);</a>
<a name="ln463"> </a>
<a name="ln464">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln465">        {</a>
<a name="ln466">            err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_PRES_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln467"> </a>
<a name="ln468">            if (pres_osr &gt;= DPS310_OS_16)</a>
<a name="ln469">            {</a>
<a name="ln470">                err_code |=  mask_set (ctx,</a>
<a name="ln471">                                       DPS310_CFG_REG,</a>
<a name="ln472">                                       DPS310_CFG_PRESSH_MASK);</a>
<a name="ln473">            }</a>
<a name="ln474"> </a>
<a name="ln475">            if (DPS310_SUCCESS == err_code)</a>
<a name="ln476">            {</a>
<a name="ln477">                ctx-&gt;pres_mr = pres_mr;</a>
<a name="ln478">                ctx-&gt;pres_osr = pres_osr;</a>
<a name="ln479">            }</a>
<a name="ln480">            else</a>
<a name="ln481">            {</a>
<a name="ln482">                err_code |= DPS310_BUS_ERROR;</a>
<a name="ln483">                ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln484">            }</a>
<a name="ln485">        }</a>
<a name="ln486">    }</a>
<a name="ln487"> </a>
<a name="ln488">    return err_code;</a>
<a name="ln489">}</a>
<a name="ln490"> </a>
<a name="ln491">dps310_status_t dps310_standby (dps310_ctx_t * const ctx)</a>
<a name="ln492">{</a>
<a name="ln493">    dps310_status_t err_code = ctx_status_check (ctx);</a>
<a name="ln494"> </a>
<a name="ln495">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln496">    {</a>
<a name="ln497">        uint8_t cmd = DPS310_MODE_STANDBY_VAL;</a>
<a name="ln498">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_MEAS_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln499"> </a>
<a name="ln500">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln501">        {</a>
<a name="ln502">            ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln503">        }</a>
<a name="ln504">        else</a>
<a name="ln505">        {</a>
<a name="ln506">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln507">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln508">        }</a>
<a name="ln509">    }</a>
<a name="ln510"> </a>
<a name="ln511">    return err_code;</a>
<a name="ln512">}</a>
<a name="ln513"> </a>
<a name="ln514">static uint8_t os_to_num (const dps310_os_t os)</a>
<a name="ln515">{</a>
<a name="ln516">    uint8_t num = 0;</a>
<a name="ln517"> </a>
<a name="ln518">    switch (os)</a>
<a name="ln519">    {</a>
<a name="ln520">    case DPS310_OS_1:</a>
<a name="ln521">        num = 1U;</a>
<a name="ln522">        break;</a>
<a name="ln523"> </a>
<a name="ln524">    case DPS310_OS_2:</a>
<a name="ln525">        num = 2U;</a>
<a name="ln526">        break;</a>
<a name="ln527"> </a>
<a name="ln528">    case DPS310_OS_4:</a>
<a name="ln529">        num = 4U;</a>
<a name="ln530">        break;</a>
<a name="ln531"> </a>
<a name="ln532">    case DPS310_OS_8:</a>
<a name="ln533">        num = 8U;</a>
<a name="ln534">        break;</a>
<a name="ln535"> </a>
<a name="ln536">    case DPS310_OS_16:</a>
<a name="ln537">        num = 16U;</a>
<a name="ln538">        break;</a>
<a name="ln539"> </a>
<a name="ln540">    case DPS310_OS_32:</a>
<a name="ln541">        num = 32U;</a>
<a name="ln542">        break;</a>
<a name="ln543"> </a>
<a name="ln544">    case DPS310_OS_64:</a>
<a name="ln545">        num = 64U;</a>
<a name="ln546">        break;</a>
<a name="ln547"> </a>
<a name="ln548">    case DPS310_OS_128:</a>
<a name="ln549">        num = 128U;</a>
<a name="ln550">        break;</a>
<a name="ln551"> </a>
<a name="ln552">    default:</a>
<a name="ln553">        num = 0;</a>
<a name="ln554">        break;</a>
<a name="ln555">    }</a>
<a name="ln556"> </a>
<a name="ln557">    return num;</a>
<a name="ln558">}</a>
<a name="ln559"> </a>
<a name="ln560">static uint32_t temp_measurement_time_get (const dps310_ctx_t * const ctx)</a>
<a name="ln561">{</a>
<a name="ln562">    // Actually 2 + 1.6 * OSR, but rounding up.</a>
<a name="ln563">    return 3U + (uint32_t) (1.6F * (float) os_to_num (ctx-&gt;temp_osr));</a>
<a name="ln564">}</a>
<a name="ln565"> </a>
<a name="ln566">static uint32_t pres_measurement_time_get (const dps310_ctx_t * const ctx)</a>
<a name="ln567">{</a>
<a name="ln568">    // Actually 2 + 1.6 * OSR, but rounding up.</a>
<a name="ln569">    return 3U + (uint32_t) (1.6F * (float) os_to_num (ctx-&gt;pres_osr));</a>
<a name="ln570">}</a>
<a name="ln571"> </a>
<a name="ln572"> </a>
<a name="ln573"> </a>
<a name="ln574">dps310_status_t dps310_measure_temp_once_sync (dps310_ctx_t * const ctx,</a>
<a name="ln575">        float * const result)</a>
<a name="ln576">{</a>
<a name="ln577">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln578"> </a>
<a name="ln579">    if (NULL == result)</a>
<a name="ln580">    {</a>
<a name="ln581">        err_code = DPS310_ERROR_NULL;</a>
<a name="ln582">    }</a>
<a name="ln583">    else if (DPS310_SUCCESS == err_code)</a>
<a name="ln584">    {</a>
<a name="ln585">        err_code |= dps310_measure_temp_once_async (ctx);</a>
<a name="ln586">        ctx-&gt;sleep (temp_measurement_time_get (ctx));</a>
<a name="ln587">        err_code |= dps310_get_single_result (ctx, result);</a>
<a name="ln588">    }</a>
<a name="ln589">    else</a>
<a name="ln590">    {</a>
<a name="ln591">        // No action needed.</a>
<a name="ln592">    }</a>
<a name="ln593"> </a>
<a name="ln594">    return err_code;</a>
<a name="ln595">}</a>
<a name="ln596"> </a>
<a name="ln597">dps310_status_t dps310_measure_temp_once_async (dps310_ctx_t * const ctx)</a>
<a name="ln598">{</a>
<a name="ln599">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln600"> </a>
<a name="ln601">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln602">    {</a>
<a name="ln603">        uint8_t cmd = DPS310_MODE_ONE_TEMP_VAL;</a>
<a name="ln604">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_MEAS_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln605"> </a>
<a name="ln606">        if (DPS310_SUCCESS != err_code)</a>
<a name="ln607">        {</a>
<a name="ln608">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln609">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln610">        }</a>
<a name="ln611">        else</a>
<a name="ln612">        {</a>
<a name="ln613">            ctx-&gt;device_status = DPS310_TEMP_RDY;</a>
<a name="ln614">        }</a>
<a name="ln615">    }</a>
<a name="ln616"> </a>
<a name="ln617">    return err_code;</a>
<a name="ln618">}</a>
<a name="ln619"> </a>
<a name="ln620">dps310_status_t dps310_measure_pres_once_async (dps310_ctx_t * const ctx)</a>
<a name="ln621">{</a>
<a name="ln622">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln623"> </a>
<a name="ln624">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln625">    {</a>
<a name="ln626">        uint8_t cmd = DPS310_MODE_ONE_PRES_VAL;</a>
<a name="ln627">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx, DPS310_MEAS_CFG_REG, &amp;cmd, 1U);</a>
<a name="ln628"> </a>
<a name="ln629">        if (DPS310_SUCCESS != err_code)</a>
<a name="ln630">        {</a>
<a name="ln631">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln632">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln633">        }</a>
<a name="ln634">        else</a>
<a name="ln635">        {</a>
<a name="ln636">            ctx-&gt;device_status = DPS310_PRES_RDY;</a>
<a name="ln637">        }</a>
<a name="ln638">    }</a>
<a name="ln639"> </a>
<a name="ln640">    return err_code;</a>
<a name="ln641">}</a>
<a name="ln642"> </a>
<a name="ln643">// Datasheet 4.9.3</a>
<a name="ln644">static uint32_t os_to_scale_factor (const dps310_os_t os)</a>
<a name="ln645">{</a>
<a name="ln646">    uint32_t sf = 0;</a>
<a name="ln647"> </a>
<a name="ln648">    switch (os)</a>
<a name="ln649">    {</a>
<a name="ln650">    case DPS310_OS_1:</a>
<a name="ln651">        sf = 524288U;</a>
<a name="ln652">        break;</a>
<a name="ln653"> </a>
<a name="ln654">    case DPS310_OS_2:</a>
<a name="ln655">        sf = 1572864U;</a>
<a name="ln656">        break;</a>
<a name="ln657"> </a>
<a name="ln658">    case DPS310_OS_4:</a>
<a name="ln659">        sf = 3670016U;</a>
<a name="ln660">        break;</a>
<a name="ln661"> </a>
<a name="ln662">    case DPS310_OS_8:</a>
<a name="ln663">        sf = 7864320U;</a>
<a name="ln664">        break;</a>
<a name="ln665"> </a>
<a name="ln666">    case DPS310_OS_16:</a>
<a name="ln667">        sf = 253952U;</a>
<a name="ln668">        break;</a>
<a name="ln669"> </a>
<a name="ln670">    case DPS310_OS_32:</a>
<a name="ln671">        sf = 516096U;</a>
<a name="ln672">        break;</a>
<a name="ln673"> </a>
<a name="ln674">    case DPS310_OS_64:</a>
<a name="ln675">        sf = 1040384U;</a>
<a name="ln676">        break;</a>
<a name="ln677"> </a>
<a name="ln678">    case DPS310_OS_128:</a>
<a name="ln679">        sf = 2088960U;</a>
<a name="ln680">        break;</a>
<a name="ln681"> </a>
<a name="ln682">    default:</a>
<a name="ln683">        sf = 1;</a>
<a name="ln684">        break;</a>
<a name="ln685">    }</a>
<a name="ln686"> </a>
<a name="ln687">    return sf;</a>
<a name="ln688">}</a>
<a name="ln689"> </a>
<a name="ln690">static float calculate_temperature (dps310_ctx_t * const ctx, const int32_t raw)</a>
<a name="ln691">{</a>
<a name="ln692">    uint32_t sf = os_to_scale_factor (ctx-&gt;temp_osr);</a>
<a name="ln693">    float raw_scaled = ( (float) raw) / ( (float) sf);</a>
<a name="ln694">    ctx-&gt;last_temp_scal = raw_scaled;</a>
<a name="ln695">    return ( (float) ctx-&gt;c0 * DPS310_C0_WEIGHT) + ( (float) ctx-&gt;c1 * raw_scaled);</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698">static float calculate_pressure (const dps310_ctx_t * const ctx, const int32_t raw)</a>
<a name="ln699">{</a>
<a name="ln700">    uint32_t sf = os_to_scale_factor (ctx-&gt;pres_osr);</a>
<a name="ln701">    float Praw_sc = ( (float) raw) / ( (float) sf);</a>
<a name="ln702">    float Traw_sc = ctx-&gt;last_temp_scal;</a>
<a name="ln703">    return ctx-&gt;c00</a>
<a name="ln704">           + Praw_sc * ( (float) ctx-&gt;c10 + Praw_sc * ( (float) ctx-&gt;c20 + Praw_sc *</a>
<a name="ln705">                         (float) ctx-&gt;c30))</a>
<a name="ln706">           + Traw_sc * (float) ctx-&gt;c01 + Traw_sc * Praw_sc * ( (float) ctx-&gt;c11 + Praw_sc *</a>
<a name="ln707">                   (float) ctx-&gt;c21);</a>
<a name="ln708">}</a>
<a name="ln709"> </a>
<a name="ln710">static inline __attribute__ ( (nonnull)) int32_t</a>
<a name="ln711">regs_to_i32 (const uint8_t * const regs)</a>
<a name="ln712">{</a>
<a name="ln713">    uint32_t b24_value = (regs[0U] &lt;&lt; 16U)</a>
<a name="ln714">                         + (regs[1U] &lt;&lt; 8U)</a>
<a name="ln715">                         + regs[2U];</a>
<a name="ln716">    return twos_complement (b24_value, 24U);</a>
<a name="ln717">}</a>
<a name="ln718"> </a>
<a name="ln719">static dps310_status_t dps310_get_single_temp (dps310_ctx_t * const ctx,</a>
<a name="ln720">        float * const result)</a>
<a name="ln721">{</a>
<a name="ln722">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln723">    uint8_t reg_value[DPS310_TEMP_VAL_LEN] = {0};</a>
<a name="ln724">    err_code |= ctx-&gt;read (ctx-&gt;comm_ctx,</a>
<a name="ln725">                           DPS310_TEMP_VAL_REG,</a>
<a name="ln726">                           reg_value,</a>
<a name="ln727">                           DPS310_TEMP_VAL_LEN);</a>
<a name="ln728"> </a>
<a name="ln729">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln730">    {</a>
<a name="ln731">        *result = calculate_temperature (ctx, regs_to_i32 (reg_value));</a>
<a name="ln732">        ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln733">    }</a>
<a name="ln734">    else</a>
<a name="ln735">    {</a>
<a name="ln736">        err_code |= DPS310_BUS_ERROR;</a>
<a name="ln737">        ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln738">    }</a>
<a name="ln739"> </a>
<a name="ln740">    return err_code;</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743">static dps310_status_t dps310_get_single_pres (dps310_ctx_t * const ctx,</a>
<a name="ln744">        float * const result)</a>
<a name="ln745">{</a>
<a name="ln746">    dps310_status_t err_code = DPS310_SUCCESS;</a>
<a name="ln747">    uint8_t reg_value[DPS310_PRES_VAL_LEN] = {0};</a>
<a name="ln748">    err_code |= ctx-&gt;read (ctx-&gt;comm_ctx,</a>
<a name="ln749">                           DPS310_PRES_VAL_REG,</a>
<a name="ln750">                           reg_value,</a>
<a name="ln751">                           DPS310_PRES_VAL_LEN);</a>
<a name="ln752"> </a>
<a name="ln753">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln754">    {</a>
<a name="ln755">        *result = calculate_pressure (ctx, regs_to_i32 (reg_value));</a>
<a name="ln756">        ctx-&gt;device_status = DPS310_READY;</a>
<a name="ln757">    }</a>
<a name="ln758">    else</a>
<a name="ln759">    {</a>
<a name="ln760">        err_code |= DPS310_BUS_ERROR;</a>
<a name="ln761">        ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln762">    }</a>
<a name="ln763"> </a>
<a name="ln764">    return err_code;</a>
<a name="ln765">}</a>
<a name="ln766"> </a>
<a name="ln767">dps310_status_t dps310_get_single_result (dps310_ctx_t * const ctx, float * const result)</a>
<a name="ln768">{</a>
<a name="ln769">    dps310_status_t err_code = ctx_done_check (ctx);</a>
<a name="ln770"> </a>
<a name="ln771">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln772">    {</a>
<a name="ln773">        if (DPS310_TEMP_RDY == ctx-&gt;device_status)</a>
<a name="ln774">        {</a>
<a name="ln775">            err_code |= dps310_get_single_temp (ctx, result);</a>
<a name="ln776">        }</a>
<a name="ln777">        else if (DPS310_PRES_RDY == ctx-&gt;device_status)</a>
<a name="ln778">        {</a>
<a name="ln779">            err_code |= dps310_get_single_pres (ctx, result);</a>
<a name="ln780">        }</a>
<a name="ln781">        else</a>
<a name="ln782">        {</a>
<a name="ln783">            // This branch should never run, tested in ctx_done_check</a>
<a name="ln784">            err_code |= DPS310_INVALID_STATE;</a>
<a name="ln785">        }</a>
<a name="ln786">    }</a>
<a name="ln787"> </a>
<a name="ln788">    return err_code;</a>
<a name="ln789">}</a>
<a name="ln790"> </a>
<a name="ln791">dps310_status_t</a>
<a name="ln792">dps310_measure_pres_once_sync (dps310_ctx_t * const ctx, float * const result)</a>
<a name="ln793">{</a>
<a name="ln794">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln795"> </a>
<a name="ln796">    if (NULL == result)</a>
<a name="ln797">    {</a>
<a name="ln798">        err_code = DPS310_ERROR_NULL;</a>
<a name="ln799">    }</a>
<a name="ln800">    else if (DPS310_SUCCESS == err_code)</a>
<a name="ln801">    {</a>
<a name="ln802">        err_code |= dps310_measure_pres_once_async (ctx);</a>
<a name="ln803">        ctx-&gt;sleep (pres_measurement_time_get (ctx));</a>
<a name="ln804">        err_code |= dps310_get_single_result (ctx, result);</a>
<a name="ln805">    }</a>
<a name="ln806">    else</a>
<a name="ln807">    {</a>
<a name="ln808">        // No action needed.</a>
<a name="ln809">    }</a>
<a name="ln810"> </a>
<a name="ln811">    return err_code;</a>
<a name="ln812">}</a>
<a name="ln813"> </a>
<a name="ln814">dps310_status_t dps310_measure_continuous_async (dps310_ctx_t * const ctx)</a>
<a name="ln815">{</a>
<a name="ln816">    dps310_status_t err_code = ctx_ready_check (ctx);</a>
<a name="ln817"> </a>
<a name="ln818">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln819">    {</a>
<a name="ln820">        uint8_t reg_value[1U] = {DPS310_MODE_CONT_BOTH_VAL};</a>
<a name="ln821">        err_code |= ctx-&gt;write (ctx-&gt;comm_ctx,</a>
<a name="ln822">                                DPS310_MEAS_CFG_REG,</a>
<a name="ln823">                                reg_value,</a>
<a name="ln824">                                1U);</a>
<a name="ln825"> </a>
<a name="ln826">        if (DPS310_SUCCESS == err_code)</a>
<a name="ln827">        {</a>
<a name="ln828">            ctx-&gt;device_status = DPS310_CONTINUOUS;</a>
<a name="ln829">        }</a>
<a name="ln830">        else</a>
<a name="ln831">        {</a>
<a name="ln832">            err_code |= DPS310_BUS_ERROR;</a>
<a name="ln833">            ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln834">        }</a>
<a name="ln835">    }</a>
<a name="ln836"> </a>
<a name="ln837">    return err_code;</a>
<a name="ln838">}</a>
<a name="ln839"> </a>
<a name="ln840">static inline __attribute__ ( (nonnull)) bool</a>
<a name="ln841">fifo_entry_is_eof (const uint8_t * const entry)</a>
<a name="ln842">{</a>
<a name="ln843">    return ( (DPS310_FIFO_VAL_EOF_B0 ==  entry[0])</a>
<a name="ln844">             &amp;&amp; (DPS310_FIFO_VAL_EOF_B1 ==  entry[1])</a>
<a name="ln845">             &amp;&amp; (DPS310_FIFO_VAL_EOF_B2 ==  entry[2]));</a>
<a name="ln846">}</a>
<a name="ln847"> </a>
<a name="ln848">static inline __attribute__ ( (nonnull)) bool</a>
<a name="ln849">fifo_entry_is_pres (const uint8_t * const entry)</a>
<a name="ln850">{</a>
<a name="ln851">    // FIFO entry type is identified by the least significant bit.</a>
<a name="ln852">    return (entry[2] &amp; 0x01U);</a>
<a name="ln853">}</a>
<a name="ln854"> </a>
<a name="ln855">dps310_status_t dps310_get_cont_results (dps310_ctx_t * const ctx, float * const temp,</a>
<a name="ln856">        uint8_t * const temp_count, float * const pres, uint8_t * const pres_count)</a>
<a name="ln857">{</a>
<a name="ln858">    dps310_status_t err_code = ctx_cont_check (ctx);</a>
<a name="ln859">    uint8_t temp_entries = 0U;</a>
<a name="ln860">    uint8_t pres_entries = 0U;</a>
<a name="ln861"> </a>
<a name="ln862">    if (DPS310_SUCCESS == err_code)</a>
<a name="ln863">    {</a>
<a name="ln864">        uint8_t fifo_entry[3U] = {0};</a>
<a name="ln865">        bool output_full = false;</a>
<a name="ln866"> </a>
<a name="ln867">        while ( (!fifo_entry_is_eof (fifo_entry)) &amp;&amp; (!output_full)</a>
<a name="ln868">                &amp;&amp; (DPS310_SUCCESS == err_code))</a>
<a name="ln869">        {</a>
<a name="ln870">            err_code |= ctx-&gt;read (ctx-&gt;comm_ctx, DPS310_FIFO_VAL_REG, fifo_entry,</a>
<a name="ln871">                                   DPS310_FIFO_VAL_LEN);</a>
<a name="ln872"> </a>
<a name="ln873">            if (fifo_entry_is_pres (fifo_entry))</a>
<a name="ln874">            {</a>
<a name="ln875">                float result = calculate_pressure (ctx, regs_to_i32 (fifo_entry));</a>
<a name="ln876">                pres[pres_entries++] = result;</a>
<a name="ln877">                output_full = (pres_entries == *pres_count);</a>
<a name="ln878">            }</a>
<a name="ln879">            else if (!fifo_entry_is_eof (fifo_entry))</a>
<a name="ln880">            {</a>
<a name="ln881">                float result = calculate_temperature (ctx, regs_to_i32 (fifo_entry));</a>
<a name="ln882">                temp[temp_entries++] = result;</a>
<a name="ln883">                output_full = (temp_entries == *temp_count);</a>
<a name="ln884">            }</a>
<a name="ln885">            else</a>
<a name="ln886">            {</a>
<a name="ln887">                // EOF</a>
<a name="ln888">                *temp_count = temp_entries;</a>
<a name="ln889">                *pres_count = pres_entries;</a>
<a name="ln890">            }</a>
<a name="ln891"> </a>
<a name="ln892">            if (DPS310_SUCCESS != err_code)</a>
<a name="ln893">            {</a>
<a name="ln894">                err_code |= DPS310_BUS_ERROR;</a>
<a name="ln895">                ctx-&gt;device_status = DPS310_BUS_ERROR;</a>
<a name="ln896">            }</a>
<a name="ln897">        }</a>
<a name="ln898">    }</a>
<a name="ln899"> </a>
<a name="ln900">    return err_code;</a>
<a name="ln901">}</a>
<a name="ln902"> </a>
<a name="ln903">/** @} */</a>

</code></pre>
<div class="balloon" rel="193"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0x09U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="220"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'revision[0U] & (0x0FU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="221"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(revision[0U] & (0xF0U)) >> (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="322"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="326"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="330"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '3U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="334"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="338"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '5U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="342"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '6U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="346"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '7U << (4U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="368"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="372"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="376"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '3U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="380"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="384"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '5U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="388"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '6U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="392"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '7U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="521"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '1U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="525"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '2U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="529"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '4U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="533"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '8U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="537"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '16U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="541"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '32U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="545"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '64U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="549"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '128U' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="553"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="563"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'float' type to unsigned integer type.</p></div>
<div class="balloon" rel="569"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2004/" target="_blank">V2004</a> Explicit conversion from 'float' type to unsigned integer type.</p></div>
<div class="balloon" rel="603"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0x02U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="626"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0x01U)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="683"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="703"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'signed' and 'floating'.</p></div>
<div class="balloon" rel="713"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '+' operator should have the same essential type. The current types are: 'signed' and 'unsigned'.</p></div>
<div class="balloon" rel="713"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'signed' type to the essential 'unsigned' type.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
